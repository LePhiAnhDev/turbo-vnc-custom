name: Build

on:
  push:
  pull_request:
  workflow_dispatch:

env:
  LJT_VERSION: 3.1.2
  LJT_GPG_KEY: https://raw.githubusercontent.com/libjpeg-turbo/repo/main/LJT-GPG-KEY

jobs:
  windows:
    runs-on: windows-2025
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set global environment variables
        shell: bash
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            RAWBRANCH=$(git branch -r --contains $GITHUB_REF)
            echo "BRANCH=${RAWBRANCH##*/}" >$GITHUB_ENV
          else
            echo "BRANCH=${GITHUB_BASE_REF:-${GITHUB_REF#refs/heads/}}" >$GITHUB_ENV
          fi
          echo "LJT_URL=https://github.com/libjpeg-turbo/libjpeg-turbo/releases/download/$LJT_VERSION" >>$GITHUB_ENV

      - name: Cache installers
        uses: actions/cache@v4
        with:
          path: c:/installers
          key: installers-${{github.job}}-${{env.BRANCH}}

      - name: Cache OpenJDK
        uses: actions/cache@v4
        with:
          path: ~/.openjdk
          key: openjdk-${{github.job}}-${{env.BRANCH}}

      - name: Set up build
        shell: bash
        run: |
          set -x
          choco install -y InnoSetup
          mkdir -p c:/installers
          if [ ! -f c:/installers/libjpeg-turbo-$LJT_VERSION-vc-x64.exe ]; then
            curl -fSL -o c:/installers/libjpeg-turbo-$LJT_VERSION-vc-x64.exe $LJT_URL/libjpeg-turbo-$LJT_VERSION-vc-x64.exe
          fi
          c:/installers/libjpeg-turbo-$LJT_VERSION-vc-x64.exe //S
          git clone --depth=1 https://github.com/nathan818fr/vcvars-bash.git c:/vcvars-bash
          BRANCH_TO_USE=${BRANCH:-master}
          echo "Using branch: $BRANCH_TO_USE"
          git clone --depth=1 https://github.com/TurboVNC/buildscripts.git -b $BRANCH_TO_USE c:/buildscripts || \
            git clone --depth=1 https://github.com/TurboVNC/buildscripts.git -b master c:/buildscripts
          mkdir -p /opt

      - name: Configure GPG signing
        if: ${{github.event_name != 'pull_request'}}
        shell: bash
        continue-on-error: true
        run: |
          mkdir -p c:/buildscripts
          if [ -n "${{secrets.GPG_KEY}}" ] && [ -n "${{secrets.GPG_KEY_NAME}}" ] && [ -n "${{secrets.GPG_KEY_ID}}" ]; then
            mkdir -p ~/.gnupg
            chmod 700 ~/.gnupg || true
            printf "${{secrets.GPG_KEY}}" | base64 --decode 2>/dev/null | gpg --batch --import - 2>/dev/null || {
              echo "Warning: Failed to import GPG key, continuing without GPG signing"
            }
            echo "GPG_KEY_NAME=\"${{secrets.GPG_KEY_NAME}}\"" >c:/buildscripts/gpgsign
            echo "GPG_KEY_ID=${{secrets.GPG_KEY_ID}}" >>c:/buildscripts/gpgsign
            if [ -n "${{secrets.GPG_KEY_PASS}}" ]; then
              echo "GPG_KEY_PASS=${{secrets.GPG_KEY_PASS}}" >>c:/buildscripts/gpgsign
            fi
          else
            echo "GPG_KEY_NAME=" >c:/buildscripts/gpgsign
            echo "GPG_KEY_ID=" >>c:/buildscripts/gpgsign
            echo "GPG_KEY_PASS=" >>c:/buildscripts/gpgsign
            echo "GPG signing not configured - Windows builds don't require GPG signing"
          fi

      - name: Build
        shell: bash
        run: |
          export VSINSTALLDIR='C:\Program Files\Microsoft Visual Studio\2022\Enterprise\'
          eval "$(c:/vcvars-bash/vcvarsall.sh amd64)"
          export PATH="$PATH:/c/Program Files (x86)/Inno Setup 6/:/c/msys64/usr/bin/"
          echo INCLUDE=$INCLUDE
          echo LIB=$LIB
          echo PATH=$PATH

          if [ ! -f c:/buildscripts/gpgsign ] || ! grep -q "GPG_KEY_ID=[^[:space:]]" c:/buildscripts/gpgsign 2>/dev/null; then
            echo "GPG signing disabled - Windows builds don't require GPG signing"
            mkdir -p /c/tools/gpg-wrapper
            printf '#!/bin/bash\n' > /c/tools/gpg-wrapper/gpg
            printf 'ARGS_STR="$*"\n' >> /c/tools/gpg-wrapper/gpg
            printf 'if echo "$ARGS_STR" | grep -q -- "--sign" || echo "$ARGS_STR" | grep -q " -s "; then\n' >> /c/tools/gpg-wrapper/gpg
            printf '  echo "GPG signing skipped (no key configured for Windows builds)" >&2\n' >> /c/tools/gpg-wrapper/gpg
            printf '  exit 0\n' >> /c/tools/gpg-wrapper/gpg
            printf 'fi\n' >> /c/tools/gpg-wrapper/gpg
            printf '/usr/bin/gpg "$@" 2>/dev/null || exit 0\n' >> /c/tools/gpg-wrapper/gpg
            chmod +x /c/tools/gpg-wrapper/gpg
            export PATH="/c/tools/gpg-wrapper:$PATH"
            echo "GPG wrapper installed to disable signing"
          fi

          c:/buildscripts/buildvnc -d $GITHUB_WORKSPACE -b /c/vnc.nightly -v
          mv /c/vnc.nightly/log-${{github.job}}.txt /c/vnc.nightly/files/

      - name: Upload build artifacts
        if: ${{github.event_name != 'pull_request'}}
        uses: actions/upload-artifact@v4
        with:
          name: TurboVNC-build-files
          path: c:/vnc.nightly/files/*
          retention-days: 30

      - name: Upload unsigned artifact
        if: ${{github.event_name == 'push' && contains(github.ref, 'refs/tags/')}}
        id: upload-unsigned-artifact
        uses: actions/upload-artifact@v4
        with:
          path: c:/vnc.nightly/files/TurboVNC-*.exe

      - name: Sign artifact
        if: ${{github.event_name == 'push' && contains(github.ref, 'refs/tags/')}}
        uses: signpath/github-action-submit-signing-request@v1.1
        with:
          api-token: ${{secrets.SIGNPATH_API_TOKEN}}
          organization-id: 616cafe1-280b-4605-ab3b-da1345d91f61
          project-slug: turbovnc
          signing-policy-slug: release-signing
          github-artifact-id: ${{steps.upload-unsigned-artifact.outputs.artifact-id}}
          wait-for-completion: true